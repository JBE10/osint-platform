# =============================================================================
# PRODUCTION Docker Compose Configuration
# =============================================================================
# 
# USAGE:
#   1. Copy this file: cp docker-compose.prod.yml docker-compose.override.yml
#   2. Fill in the REQUIRED secrets below
#   3. Run: docker compose up -d
#
# SECURITY CHECKLIST:
#   [ ] JWT_SECRET_KEY - Generate with: openssl rand -hex 32
#   [ ] POSTGRES_PASSWORD - Strong password
#   [ ] MINIO credentials - Strong credentials
#   [ ] ENV=prod is set
#   [ ] DEBUG=false is set
#
# =============================================================================

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: osint
      POSTGRES_USER: osint
      # REQUIRED: Set a strong password
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "127.0.0.1:5432:5432"  # Only localhost in prod
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U osint -d osint"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7
    command: redis-server --requirepass ${REDIS_PASSWORD:-}
    ports:
      - "127.0.0.1:6379:6379"  # Only localhost in prod
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      # REQUIRED: Set strong credentials
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY is required}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY is required}
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    volumes:
      - miniodata:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  api:
    build: ./api
    environment:
      # SECURITY: Production mode enabled
      ENV: prod
      DEBUG: "false"
      
      # Database
      DATABASE_URL: postgresql+psycopg://osint:${POSTGRES_PASSWORD}@postgres:5432/osint
      
      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/0
      
      # MinIO
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: evidence
      
      # REQUIRED: JWT Secret (generate with: openssl rand -hex 32)
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required - run: openssl rand -hex 32}
    ports:
      - "127.0.0.1:8000:8000"  # Put behind reverse proxy in prod
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped

  worker:
    build: ./worker
    environment:
      ENV: prod
      DATABASE_URL: postgresql+psycopg://osint:${POSTGRES_PASSWORD}@postgres:5432/osint
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-}@redis:6379/1
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD:-}@redis:6379/2
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pgdata:
  miniodata:

# =============================================================================
# Example .env file for production:
# =============================================================================
# 
# # Generate secrets:
# # JWT_SECRET_KEY=$(openssl rand -hex 32)
# # POSTGRES_PASSWORD=$(openssl rand -hex 16)
# # MINIO_SECRET_KEY=$(openssl rand -hex 16)
# 
# JWT_SECRET_KEY=your-64-char-hex-string-here
# POSTGRES_PASSWORD=your-strong-db-password
# MINIO_ACCESS_KEY=osint-minio-admin
# MINIO_SECRET_KEY=your-strong-minio-password
# REDIS_PASSWORD=your-redis-password
#
# =============================================================================

